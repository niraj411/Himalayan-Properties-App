generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          String    @default("TENANT") // ADMIN or TENANT
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant?
  reminders     Reminder[]
}

model Property {
  id          String   @id @default(cuid())
  name        String
  type        String   // RESIDENTIAL or COMMERCIAL
  address     String
  city        String
  state       String
  zip         String
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  units        Unit[]
  applications Application[]
}

model Unit {
  id         String   @id @default(cuid())
  propertyId String
  unitNumber String
  bedrooms   Int?
  bathrooms  Float?
  sqft       Int?
  rent       Float
  status     String   @default("VACANT") // VACANT, OCCUPIED, MAINTENANCE
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property            Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant              Tenant?
  leases              Lease[]
  maintenanceRequests MaintenanceRequest[]

  @@unique([propertyId, unitNumber])
}

model Tenant {
  id               String    @id @default(cuid())
  userId           String    @unique
  unitId           String?   @unique
  moveInDate       DateTime?
  moveOutDate      DateTime?
  emergencyContact String?
  emergencyPhone   String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit                Unit?                @relation(fields: [unitId], references: [id])
  leases              Lease[]
  maintenanceRequests MaintenanceRequest[]
}

model Lease {
  id            String   @id @default(cuid())
  tenantId      String
  unitId        String
  leaseType     String   @default("RESIDENTIAL") // RESIDENTIAL or COMMERCIAL
  startDate     DateTime
  endDate       DateTime
  monthlyRent   Float
  depositAmount Float?
  documentUrl   String?
  status        String   @default("ACTIVE") // ACTIVE, EXPIRED, TERMINATED
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit        Unit             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  payments    Payment[]
  escalations LeaseEscalation[]
  insurance   InsuranceRecord[]
}

// Lease escalations for commercial properties
model LeaseEscalation {
  id              String   @id @default(cuid())
  leaseId         String
  effectiveDate   DateTime
  newMonthlyRent  Float
  increaseType    String   // PERCENTAGE, FIXED_AMOUNT, CPI
  increaseValue   Float?   // e.g., 3 for 3% or 100 for $100
  notes           String?
  applied         Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)
}

// Insurance tracking for commercial tenants
model InsuranceRecord {
  id                  String    @id @default(cuid())
  leaseId             String
  insuranceType       String    @default("LIABILITY") // LIABILITY, PROPERTY, WORKERS_COMP
  carrier             String?
  policyNumber        String?
  coverageAmount      Float?
  effectiveDate       DateTime
  expirationDate      DateTime
  documentUrl         String?
  beneficiaryName     String    @default("Himalayan Holdings Property LLC")
  verified            Boolean   @default(false)
  verifiedAt          DateTime?
  reminderSent        Boolean   @default(false)
  reminderSentAt      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)
}

model Application {
  id              String   @id @default(cuid())
  propertyId      String?
  applicationType String   @default("RESIDENTIAL") // RESIDENTIAL or COMMERCIAL
  firstName       String
  lastName        String
  email           String
  phone           String
  currentAddress  String?
  employerName    String?
  employerPhone   String?
  jobTitle        String?
  monthlyIncome   Float?
  moveInDate      DateTime?
  numberOfOccupants Int?
  pets            String?
  references      String?
  additionalNotes String?
  // Commercial application fields
  businessName        String?
  taxReturnsUrl       String?  // 2 years of corporate tax returns
  bankStatementsUrl   String?  // 3 months of bank statements
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  property Property? @relation(fields: [propertyId], references: [id])
}

model MaintenanceRequest {
  id          String   @id @default(cuid())
  tenantId    String
  unitId      String
  title       String
  description String
  category    String?  // PLUMBING, ELECTRICAL, HVAC, APPLIANCE, OTHER
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, EMERGENCY
  status      String   @default("OPEN") // OPEN, IN_PROGRESS, COMPLETED, CANCELLED
  imageUrls   String?  // JSON array of image URLs
  notes       String?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)
}

model Payment {
  id        String   @id @default(cuid())
  leaseId   String
  amount    Float
  date      DateTime
  method    String?  // BANK_TRANSFER, CHECK, CASH, OTHER
  reference String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)
}

model Reminder {
  id        String   @id @default(cuid())
  userId    String
  type      String   // LEASE_EXPIRY, RENT_DUE, MAINTENANCE, CUSTOM
  title     String
  message   String?
  dueDate   DateTime
  entityId  String?  // ID of related entity (lease, maintenance request, etc.)
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Settings {
  id             String  @id @default(cuid())
  companyName    String  @default("Himalayan Properties")
  companyEmail   String?
  companyPhone   String?
  companyAddress String?
  bankName       String?
  bankRoutingNumber String?
  bankAccountNumber String?
  checkMailingAddress String?
  paymentInstructions String?
}

// QuickBooks Integration
model QuickBooksToken {
  id            String   @id @default(cuid())
  realmId       String   @unique
  accessToken   String
  refreshToken  String
  accessTokenExpiresAt  DateTime
  refreshTokenExpiresAt DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
